image: arch_carv

stages:
  - build
  - unit_test
  - coverage
  - controller
  - build_all
  - docs

build_spin:
  stage: build
  script:
    - mkdir -p build
    - cd build; cmake -DDEBUG=ON -DVINE_CONFIG_FILE="$PWD/../vineconf" -Dasync_architecture=spin ../; make -j 4; cd ../
    - ./ci_scripts/vine_pack.sh 0 . spin
  artifacts:
    paths:
      - spin.tgz
    expire_in: 2 hour
  when: manual

build_mutex:
  stage: build
  script:
    - mkdir -p build
    - cd build; cmake -DDEBUG=ON -DVINE_CONFIG_FILE="$PWD/../vineconf" -Dasync_architecture=mutex ../; make -j 4; cd ../
    - ./ci_scripts/vine_pack.sh 0 . mutex
  artifacts:
    paths:
      - mutex.tgz
    expire_in: 24 hour

build_ivshmem:
  stage: build
  script:
    - mkdir -p build
    - cd build; cmake -DDEBUG=ON -DVINE_CONFIG_FILE="$PWD/../vineconf" -Dasync_architecture=ivshmem ../; make -j 4; cd ../
    - ./ci_scripts/vine_pack.sh 0 . ivshmem
  artifacts:
    paths:
      - ivshmem.tgz
    expire_in: 2 hour
  when: manual

build_all_spin:
  stage: build
  script:
    - export gen_art=spin;./tools/build_check.sh spin
  when: manual

build_all_mutex:
  stage: build_all
  script:
    - export gen_art=mutex;./tools/build_check.sh mutex
  when: manual

build_all_ivshmem:
  stage: build
  script:
    - export gen_art=ivshmem;./tools/build_check.sh ivshmem
  when: manual

utest_spin:
  stage: unit_test
  script:
    - ./ci_scripts/vine_pack.sh 1 . spin
    - cd build && ctest -V -W
  dependencies:
    - build_spin
  when: manual

utest_mutex:
  stage: unit_test
  script:
    - ./ci_scripts/vine_pack.sh 1 . mutex
    - cd build && ctest -V -W
  dependencies:
    - build_mutex
  when: manual

utest_ivshmem:
  stage: unit_test
  script:
    - ./ci_scripts/vine_pack.sh 1 . ivshmem
    - cd build && ctest -V -W
  dependencies:
    - build_ivshmem
  when: manual

coverage_mutex:
  stage: coverage
  script:
    - ./ci_scripts/vine_pack.sh 1 . mutex
    - cd build
    - cmake .. -DCOVERAGE=ON -DBUILD_TESTS=ON
    - make -j 4
    - make cov
  dependencies:
    - build_mutex

build_doc:
  stage: docs
  script:
    - mkdir -p build
    - cd build
    - cmake ../
    - make doc
    - cd docs
    - mv html VinetalkDocs
    - zip -g VinetalkDocs.zip VinetalkDocs/*
  artifacts:
    paths:
      - build/docs/VinetalkDocs.zip
    expire_in: 30 days

controller:
  stage: controller
  script:
    - git clone --depth 1 https://gitlab-ci-token:${CI_JOB_TOKEN}@carvgit.ics.forth.gr/vineyard/vine_controller.git -b ${CI_BUILD_REF_NAME}
    - cd vine_controller
    - mkdir build
    - cd build
    - cmake -DVINE_TALK_BUILD_PATH=../../ ../
    - make -j
    - set
    - env
    - ls -l
  dependencies:
    - build_mutex
