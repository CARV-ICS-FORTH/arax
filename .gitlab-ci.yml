image: carvicsforth/arch_carv

stages:
  - build
  - test
  - controller
  - build_all
  - docs
  - pub_docs
  - report

build_spin:
  stage: build
  script:
    - mkdir -p build
    - cd build; cmake -DDEBUG=ON -DVINE_CONFIG_FILE="$PWD/../vineconf" -Dasync_architecture=spin ../; make -j 4; cd ../
    - ./ci_scripts/vine_pack.sh 0 . spin
  artifacts:
    paths:
      - spin.tgz
    expire_in: 2 hour
  when: manual

build_mutex:
  stage: build
  script:
    - mkdir -p build
    - cd build; cmake -DCMAKE_BUILD_TYPE=DEBUG -DDEBUG=ON -DVINE_CONFIG_FILE="$PWD/../vineconf" -Dasync_architecture=mutex ../; make -j 4; cd ../
    - ./ci_scripts/vine_pack.sh 0 . mutex
  artifacts:
    paths:
      - mutex.tgz
    expire_in: 24 hour

build_ivshmem:
  stage: build
  script:
    - mkdir -p build
    - cd build; cmake -DDEBUG=ON -DVINE_CONFIG_FILE="$PWD/../vineconf" -Dasync_architecture=ivshmem ../; make -j 4; cd ../
    - ./ci_scripts/vine_pack.sh 0 . ivshmem
  artifacts:
    paths:
      - ivshmem.tgz
    expire_in: 2 hour
  when: manual

build_all_spin:
  stage: build_all
  script:
    - export gen_art=spin;./tools/build_check.sh spin
  when: manual

build_all_mutex:
  stage: build_all
  script:
    - export gen_art=mutex;./tools/build_check.sh mutex
  when: manual

build_all_ivshmem:
  stage: build_all
  script:
    - export gen_art=ivshmem;./tools/build_check.sh ivshmem
  when: manual

utest_spin:
  stage: test
  script:
    - ./ci_scripts/vine_pack.sh 1 . spin
    - cd build && ctest -V -W
  dependencies:
    - build_spin
  when: manual

utest_mutex:
  stage: test
  script:
    - ulimit -c 0
    - ./ci_scripts/vine_pack.sh 1 . mutex
    - cd build && ctest -V -W
  dependencies:
    - build_mutex
  retry: 2

utest_ivshmem:
  stage: test
  script:
    - ./ci_scripts/vine_pack.sh 1 . ivshmem
    - cd build && ctest -V -W
  dependencies:
    - build_ivshmem
  when: manual

coverage_mutex:
  stage: test
  script:
    - ./ci_scripts/vine_pack.sh 1 . mutex
    - cd build
    - echo -e "\e[0Ksection_start:`date +%s`:cmake[collapsed=true]\r\e[0KCMake"
    - cmake .. -DCOVERAGE=ON -DBUILD_TESTS=ON
    - echo -e "\e[0Ksection_end:`date +%s`:cmake\r\e[0K"
    - echo -e "\e[0Ksection_start:`date +%s`:make[collapsed=true]\r\e[0KMake"
    - make -j 4
    - echo -e "\e[0Ksection_end:`date +%s`:make\r\e[0K"
    - make cov
    - pip install htmlark
    - htmlark -o cov.html ./coverage/coverage.html
  artifacts:
    paths:
      - build/cov.html
    expire_in: 7 Day
  dependencies:
    - build_mutex
  retry: 2

pahole:
  stage: test
  script:
    - ./ci_scripts/vine_pack.sh 1 . mutex
    - python ./tools/pahole.py
  dependencies:
    - build_mutex

build_doc:
  stage: build
  script:
    - mkdir -p build
    - cd build
    - cmake ../
    - make doc
    - cd docs
    - mv html VinetalkDocs
    - zip -gr VinetalkDocs.zip VinetalkDocs/*
  artifacts:
    paths:
      - build/docs/VinetalkDocs.zip
    expire_in: 1 Day
  only:
    refs:
      - master


publish_doc:
  stage: pub_docs
  script:
    - echo -e "\e[0Ksection_start:`date +%s`:heroku[collapsed=true]\r\e[0KBuild heroku"
    - sudo -u makepkg yay -Suy heroku-cli-bin unzip --noconfirm
    - echo -e "\e[0Ksection_end:`date +%s`:heroku\r\e[0K"
    - bash ci_scripts/pub_doc.sh
  dependencies:
    - build_doc
  only:
    refs:
      - master

controller:
  stage: test
  script:
    - echo "shm_file /dev/shm/${CI_JOB_TOKEN}" > ~/.vinetalk
    - export BRANCH_FOUND=`cat .vine_controller`
    - echo "Using controller branch \'${BRANCH_FOUND}\'"
    - git clone --depth 1 https://gitlab-ci-token:${CI_JOB_TOKEN}@carvgit.ics.forth.gr/vineyard/vine_controller.git -b ${BRANCH_FOUND}
    - echo -e "\e[0Ksection_start:`date +%s`:vtbuild[collapsed=true]\r\e[0KBuild VineTalk"
    - mkdir -p build
    - cd build
    - cmake .. -DBUILD_TESTS=OFF -DVINE_CONTROLER_PATH=../vine_controller/ -DCMAKE_BUILD_TYPE=DEBUG -DJVineTalk=ON -Dasync_architecture=mutex
    - make -j all noop noop_stress
    - make install
    - export VT_BUILD=`pwd`
    - echo ${VT_BUILD}
    - ls
    - cd -
    - cd vine_controller
    - echo -e "\e[0Ksection_end:`date +%s`:vtbuild\r\e[0K"
    - cp ci/rr_cpu.json conf.json
    - mkdir -p build
    - cd build
    - pwd
    - echo -e "\e[0Ksection_start:`date +%s`:vcconf[collapsed=true]\r\e[0KConfigure Controller"
    - cmake -DVINE_TALK_BUILD_PATH=${VT_BUILD} ..
    - echo -e "\e[0Ksection_end:`date +%s`:vcconf\r\e[0K"
    - echo -e "\e[0Ksection_start:`date +%s`:vcbuild[collapsed=true]\r\e[0KBuild Controller"
    - make -j
    - echo -e "\e[0Ksection_end:`date +%s`:vcbuild\r\e[0K"
    - cat ../conf.json
    - make run &
    - cd ${VT_BUILD}
    - sleep 1
    - catchsegv ./noop/noop '!skrow C nialP'
    - ./vinegrind/vinegrind --all
    - java -jar JVTalk.jar '!skrow avaJ'
    - ./vinegrind/vinegrind --all
    - catchsegv ./noop/noop_stress
    - killall -SIGINT vine_controller
    - sleep 1
  retry: 2

report:
  stage: report
  script:
    - python ./ci_scripts/report.py
  when: always
